name: Promote and Cleanup Secrets

on:
  workflow_dispatch:

jobs:
  promote-secrets:
    runs-on: ubuntu-latest

    env:
      ORG: microservices-final-project
      SECRETS_LIST: |
        DOCKERHUB_TOKEN
        DOCKERHUB_USERNAME
        ACR_NAME
        DOCKER_USERNAME
        DOCKER_PASSWORD
        AZURE_CLIENT_ID
        AZURE_TENANT_ID
        AZURE_SUBSCRIPTION_ID
        AZURE_CLIENT_SECRET
        CREDS
        RESOURCE_GROUP

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install GitHub CLI
        run: sudo apt-get update && sudo apt-get install gh -y

      - name: Authenticate with GitHub CLI
        run: echo "${{ secrets.GH_PAT }}" | gh auth login --with-token

      - name: Set Organization Secrets from this repo
        run: |
          while read secret; do
            value="${{ secrets[secret] }}"
            # Special case for RESOURCE_GROUP (needs output)
            if [ "$secret" = "RESOURCE_GROUP" ]; then
              value="${{ steps.tf_outputs.outputs.resource_group_name }}"
            fi
            echo "Setting org secret: $secret"
            echo "$value" | gh secret set "$secret" --org "$ORG" --repos "${{ github.repository }}"
          done <<< "$SECRETS_LIST"

      - name: Delete secrets from current repo
        run: |
          while read secret; do
            echo "Deleting $secret from ${{ github.repository }}"
            gh secret delete "$secret" --repo "${{ github.repository }}" || true
          done <<< "$SECRETS_LIST"

      - name: Delete secrets from other repos
        run: |
          repos=("service-discovery" "cloud-config" "api-gateway" "proxy-client" "order-service" "payment-service" "product-service" "shipping-service" "user-service" "favourite-service")

          for repo in "${repos[@]}"; do
            for secret in $SECRETS_LIST; do
              echo "Deleting $secret from $ORG/$repo"
              gh secret delete "$secret" --repo "$ORG/$repo" || true
            done
          done
